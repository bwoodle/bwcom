name: Deploy brentwoodle.com to AWS
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Build Next.js
        run: |
          cd bwcom-next
          npm ci
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
          NEXTAUTH_URL=https://brentwoodle.com \
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
          npm run build
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      - name: Login to ECR
        run: aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 685339315795.dkr.ecr.us-west-2.amazonaws.com
      - name: Build and Push Docker
        run: |
          docker build -t bwcom-next ./bwcom-next
          # tag with git sha and push
          SHA=${GITHUB_SHA}
          docker tag bwcom-next:latest 685339315795.dkr.ecr.us-west-2.amazonaws.com/bwcom-next:${SHA}
          docker push 685339315795.dkr.ecr.us-west-2.amazonaws.com/bwcom-next:${SHA}
          # optionally update 'latest' tag in registry
          docker tag bwcom-next:latest 685339315795.dkr.ecr.us-west-2.amazonaws.com/bwcom-next:latest
          docker push 685339315795.dkr.ecr.us-west-2.amazonaws.com/bwcom-next:latest
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        working-directory: bwcom-terraform/env/prod
      - name: Terraform Init
        run: terraform init
        working-directory: bwcom-terraform/env/prod
      - name: Terraform Plan
        run: terraform plan
        working-directory: bwcom-terraform/env/prod
        env:
          TF_VAR_nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
          TF_VAR_nextauth_url: ${{ secrets.NEXTAUTH_URL }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          TF_VAR_image_tag: ${{ github.sha }}
      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: bwcom-terraform/env/prod
        env:
          TF_VAR_nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
          TF_VAR_nextauth_url: ${{ secrets.NEXTAUTH_URL }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          TF_VAR_image_tag: ${{ github.sha }}